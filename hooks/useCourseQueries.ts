import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Course } from '@/types';
import { useAuth } from '@/contexts/AuthContext';
import { auth } from '@/lib/firebase';

// For MVP development, use localhost. In production, use deployed functions URL
const FUNCTIONS_BASE_URL = process.env.NODE_ENV === 'development' 
  ? 'http://127.0.0.1:5001/elira-landing-ce927/europe-west1/api'
  : (process.env.NEXT_PUBLIC_FIREBASE_FUNCTIONS_URL || 'https://api-5k33v562ya-ew.a.run.app');

export const useCourses = () => {
  return useQuery({
    queryKey: ['courses'],
    queryFn: async () => {
      const response = await fetch(`${FUNCTIONS_BASE_URL}/courses`);
      if (!response.ok) throw new Error('Failed to fetch courses');
      const data = await response.json();
      return data.courses || [];
    },
  });
};

export const useCourse = (id: string) => {
  const { user } = useAuth();
  
  return useQuery({
    queryKey: ['course', id],
    queryFn: async () => {
      console.log('üîç [useCourse] Fetching course from API - Course ID:', id);
      
      try {
        // Build the API URL with optional auth token
        const headers: HeadersInit = {
          'Content-Type': 'application/json',
        };
        
        // Add auth token if user is logged in
        if (user && auth.currentUser) {
          const token = await auth.currentUser.getIdToken();
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch(`${FUNCTIONS_BASE_URL}/courses/${id}`, {
          headers,
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('Course not found');
          }
          throw new Error(`Failed to fetch course: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success || !data.course) {
          throw new Error('Invalid response format');
        }
        
        // Transform the data to match our frontend structure
        const course = data.course;
        const modules = data.modules || [];
        const lessons = data.lessons || {};
        
        // Build the complete course object with nested modules and lessons
        const transformedCourse: Course = {
          id: course.id,
          title: course.title,
          slug: course.slug,
          description: course.description,
          shortDescription: course.shortDescription || course.description,
          status: course.status,
          
          // Instructor info
          instructor: {
            id: course.instructorId,
            firstName: course.instructorName?.split(' ')[0] || 'Unknown',
            lastName: course.instructorName?.split(' ').slice(1).join(' ') || 'Instructor',
            email: course.instructorEmail || '',
            role: 'INSTRUCTOR' as const,
            profilePictureUrl: course.instructorPhotoUrl,
            title: course.instructorBio,
            createdAt: course.createdAt,
            updatedAt: course.updatedAt,
          },
          
          // Category
          category: {
            id: course.categoryId,
            name: course.categoryName || 'Uncategorized',
          },
          
          // Modules with nested lessons
          modules: modules.map((module: any) => ({
            id: module.id,
            title: module.title,
            description: module.description,
            order: module.order,
            status: 'PUBLISHED' as const,
            totalLessons: module.totalLessons,
            totalDuration: module.totalDuration,
            lessons: (lessons[module.id] || []).map((lesson: any) => ({
              id: lesson.id,
              title: lesson.title,
              description: lesson.description,
              content: lesson.content,
              type: lesson.type,
              order: lesson.order,
              status: 'PUBLISHED' as const,
              videoUrl: lesson.content?.videoUrl,
              duration: lesson.duration,
              isFreePreview: lesson.isFreePreview,
              createdAt: lesson.createdAt,
              updatedAt: lesson.updatedAt,
            })),
          })),
          
          // Stats
          averageRating: course.averageRating || 0,
          reviewCount: course.totalReviews || 0,
          enrollmentCount: course.enrollmentCount || 0,
          
          // Media
          thumbnailUrl: course.thumbnailUrl || '/images/course-placeholder.png',
          previewVideoUrl: course.previewVideoUrl,
          
          // Pricing
          price: course.price || 0,
          isFree: course.isFree || false,
          stripePriceId: course.stripePriceId,
          
          // Learning info
          objectives: course.objectives || [],
          prerequisites: course.prerequisites || [],
          
          // Settings
          certificateEnabled: course.certificateEnabled || false,
          language: course.language || 'hu',
          difficulty: course.difficulty || 'BEGINNER',
          
          // Timestamps
          createdAt: course.createdAt,
          updatedAt: course.updatedAt,
          publishDate: course.publishedAt,
          
          // Additional fields
          isPlus: course.isPlus || false,
          reviews: [],
        };
        
        console.log('‚úÖ [useCourse] Successfully fetched course:', transformedCourse.title);
        return transformedCourse;
      } catch (error) {
        console.error('‚ùå [useCourse] Error fetching course:', error);
        
        // Fallback to integrated course data for ai-copywriting-course
        if (id === 'ai-copywriting-course') {
          console.log('‚ö†Ô∏è [useCourse] Using integrated course data for ai-copywriting-course');
          return ({
            id: id,
            title: 'Olvass a vev≈ëid gondolataiban',
            slug: 'ai-copywriting-course',
            description: 'AI-alap√∫ copywriting √©s marketingkutat√°s kurzus. K√©pzeld el, hogy percek alatt k√©sz√≠tesz buyer person√°t, pontosan felt√©rk√©pezed a piacodat, √©s az MI-vel olyan sz√∂vegeket √≠rsz, amelyek nem csak a figyelmet ragadj√°k meg, hanem profitot is termelnek.',
            shortDescription: 'Tanulj meg hat√©kony sz√∂vegeket √≠rni AI eszk√∂z√∂kkel √©s ChatGPT-vel.',
            instructor: {
              id: 'zoltan-somosi',
              firstName: 'Somosi',
              lastName: 'Zolt√°n',
              email: 'zoltan@elira.hu',
              role: 'INSTRUCTOR' as const,
              profilePictureUrl: '/IMG_5730.JPG',
              title: 'Marketing Specialista & Doktorandusz',
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            },
            category: {
              id: 'ai-marketing',
              name: 'AI Marketing'
            },
            modules: [
              {
                id: 'module-1',
                courseId: id,
                title: 'Alkoss hidat k√∂zted, √©s a vev≈ë k√∂z√∂tt - hogyan √©rintsd meg a vev≈ëdet',
                description: 'A kommunik√°ci√≥dban mindig te vagy a f≈ëh≈ës, nem a vev≈ë. Tal√°ld meg a k√∂z√∂s nevez≈ët a vev≈ëddel.',
                order: 0,
                totalLessons: 1,
                totalDuration: 240,
                status: 'PUBLISHED' as const,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                lessons: [
                  {
                    id: 'lesson-1-1',
                    moduleId: 'module-1',
                    courseId: id,
                    title: 'Bevezet√©s - Hogyan ford√≠tsd meg a kommunik√°ci√≥t, hogy a vev≈ë azt mondja: ‚ÄûPont ≈ë kell nekem"',
                    description: 'A kommunik√°ci√≥ megford√≠t√°s√°nak technik√°ja',
                    type: 'VIDEO' as const,
                    order: 0,
                    duration: 240,
                    videoUrl: 'https://player.mux.com/02emHt502GnvD7gW8GjfkzNQmWGkwQR7Rcin02HAbYBDzs?metadata-video-title=Hogyan+ford%C3%ADtsd+meg+a+kommunik%C3%A1ci%C3%B3t%2C+hogy+a+vev%C5%91+azt+mondja%3A+%E2%80%9EPont+%C5%91+kell+nekem%E2%80%9D&video-title=Hogyan+ford%C3%ADtsd+meg+a+kommunik%C3%A1ci%C3%B3t%2C+hogy+a+vev%C5%91+azt+mondja%3A+%E2%80%9EPont+%C5%91+kell+nekem%E2%80%9D',
                    isFreePreview: true,
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  }
                ]
              },
              {
                id: 'module-2',
                courseId: id,
                title: 'Hogyan √°ll√≠tsd be a kommunik√°ci√≥d, hogy csak azok hallj√°k, akik fizetni fognak',
                description: 'Pontos c√©lz√°s √©s c√©lcsoport meghat√°roz√°s AI eszk√∂z√∂kkel.',
                order: 1,
                totalLessons: 3,
                totalDuration: 720,
                status: 'PUBLISHED' as const,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                lessons: [
                  {
                    id: 'lesson-2-1',
                    moduleId: 'module-2', 
                    courseId: id,
                    title: 'Pontos c√©lz√°s, biztos tal√°lat - tal√°lj c√©lba a c√©lcsoportodn√°l',
                    description: 'C√©lcsoport meghat√°roz√°s technik√°i',
                    type: 'VIDEO' as const,
                    order: 0,
                    duration: 240,
                    videoUrl: 'https://player.mux.com/9nUiGBHsu00erzpCSdEgfE2P27R4H2XqSMvZq02JOWzgM?metadata-video-title=Pontos+c%C3%A9lz%C3%A1s%2C+biztos+tal%C3%A1lat+-+tal%C3%A1lj+c%C3%A9lba+a+c%C3%A9lcsoportodn%C3%A1l&video-title=Pontos+c%C3%A9lz%C3%A1s%2C+biztos+tal%C3%A1lat+-+tal%C3%A1lj+c%C3%A9lba+a+c%C3%A9lcsoportodn%C3%A1l',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-2-2',
                    moduleId: 'module-2',
                    courseId: id,
                    title: 'V√©lem√©nyek √©s trendek - hogyan der√≠tsd ki mire v√°gynak √©s mit≈ël f√©lnek a potenci√°lis v√°s√°rl√≥id?',
                    description: 'Piackutat√°s √©s trendanal√≠zis',
                    type: 'VIDEO' as const,
                    order: 1,
                    duration: 240,
                    videoUrl: 'https://player.mux.com/Q5ai00WXITXwlLsiODwO2DGbGqXp5YnlIk7VPbUKzlRU?metadata-video-title=V%C3%A9lem%C3%A9nyek+%C3%A9s+trendek+-+hogyan+der%C3%ADtsd+ki+mire+v%C3%A1gynak+%C3%A9s+mit%C5%91l+f%C3%A9lnek+a+potenci%C3%A1lis+v%C3%A1s%C3%A1rl%C3%B3id%3F&video-title=V%C3%A9lem%C3%A9nyek+%C3%A9s+trendek+-+hogyan+der%C3%ADtsd+ki+mire+v%C3%A1gynak+%C3%A9s+mit%C5%91l+f%C3%A9lnek+a+potenci%C3%A1lis+v%C3%A1s%C3%A1rl%C3%B3id%3F',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-2-3',
                    moduleId: 'module-2',
                    courseId: id,
                    title: '√ñsszefoglal√°s - a legfontosabb vev≈ëi insightok',
                    description: 'Vev≈ëi meg√©rt√©s √∂sszegz√©se',
                    type: 'VIDEO' as const,
                    order: 2,
                    duration: 240,
                    videoUrl: 'https://player.mux.com/P004bsdgUZWZUkP00V2XHEz02jLciWlHW36UxRKjr5VSjs?metadata-video-title=%C3%96sszefoglal%C3%A1s+-+a+legfontosabb+vev%C5%91i+insightok&video-title=%C3%96sszefoglal%C3%A1s+-+a+legfontosabb+vev%C5%91i+insightok',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  }
                ]
              },
              {
                id: 'module-3',
                courseId: id,
                title: 'Ha nem ismered a vev≈ëdet, elvesz√≠ted a piacot t√©rk√©pezd fel azonnal!',
                description: 'Buyer persona k√©sz√≠t√©s √©s piackutat√°s AI eszk√∂z√∂kkel.',
                order: 2,
                totalLessons: 1,
                totalDuration: 540,
                status: 'PUBLISHED' as const,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                lessons: [
                  {
                    id: 'lesson-3-1',
                    moduleId: 'module-3',
                    courseId: id,
                    title: 'Buyer persona - komplett vev≈ëi profil meghat√°roz√°sa 10 perc alatt ChatGPT-vel, val√≥s adatokb√≥l',
                    description: 'Buyer persona automatikus gener√°l√°sa',
                    type: 'VIDEO' as const,
                    order: 0,
                    duration: 540,
                    videoUrl: 'https://player.mux.com/Dj8qeORP01O2itqZzfqXnomhIB7c01HMn5Zraaltf6AAk?metadata-video-title=Buyer+persona+-+komplett+vev%C5%91i+profil+meghat%C3%A1roz%C3%A1sa+10+perc+alatt+ChatGPT-vel%2C+val%C3%B3s+adatokb%C3%B3l&video-title=Buyer+persona+-+komplett+vev%C5%91i+profil+meghat%C3%A1roz%C3%A1sa+10+perc+alatt+ChatGPT-vel%2C+val%C3%B3s+adatokb%C3%B3l',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  }
                ]
              },
              {
                id: 'module-4',
                courseId: id,
                title: 'Hogyan √≠rd √∫gy az √ºzeneted, hogy el≈ësz√∂r √©rezze, azt√°n √©rtse meg ‚Äì √©s v√©g√ºl v√°s√°roljon',
                description: 'Pszichol√≥giai triggerek √©s √©rzelmi copywriting technik√°k.',
                order: 3,
                totalLessons: 5,
                totalDuration: 720,
                status: 'PUBLISHED' as const,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                lessons: [
                  {
                    id: 'lesson-4-1',
                    moduleId: 'module-4',
                    courseId: id,
                    title: '√ârintsd meg a sz√≠v√©t, azt√°n a fej√©t - √≠gy nyersz √∂r√∂kre v√°s√°rl√≥t!',
                    description: '√ârzelmi kapcsolat kialak√≠t√°sa',
                    type: 'VIDEO' as const,
                    order: 0,
                    duration: 120,
                    videoUrl: 'https://player.mux.com/4nerha00pbGODs00T2Z027GY4xKZBDhmVYrkxyiSAq01T01A?metadata-video-title=%C3%89rintsd+meg+a+sz%C3%ADv%C3%A9t%2C+azt%C3%A1n+a+fej%C3%A9t+-+%C3%ADgy+nyersz+%C3%B6r%C3%B6kre+v%C3%A1s%C3%A1rl%C3%B3t%21&video-title=%C3%89rintsd+meg+a+sz%C3%ADv%C3%A9t%2C+azt%C3%A1n+a+fej%C3%A9t+-+%C3%ADgy+nyersz+%C3%B6r%C3%B6kre+v%C3%A1s%C3%A1rl%C3%B3t%21',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-4-2',
                    moduleId: 'module-4',
                    courseId: id,
                    title: 'Haszn√°ld a ‚ÄûNa √©s?" technik√°t, hogy eljuss az el≈ëny√∂kh√∂z',
                    description: 'El≈ëny√∂k kommunik√°ci√≥ja',
                    type: 'VIDEO' as const,
                    order: 1,
                    duration: 60,
                    videoUrl: 'https://player.mux.com/00N600Lzl6rQQxVBeOj02yUcHwTAer00W68fceHwxrdb00fM?metadata-video-title=Haszn%C3%A1ld+a+%22Na+%C3%A9s%3F%22+technik%C3%A1t%2C+hogy+eljuss+az+el%C5%91ny%C3%B6kh%C3%B6z&video-title=Haszn%C3%A1ld+a+%22Na+%C3%A9s%3F%22+technik%C3%A1t%2C+hogy+eljuss+az+el%C5%91ny%C3%B6kh%C3%B6z',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-4-3',
                    moduleId: 'module-4',
                    courseId: id,
                    title: 'Vev≈ëi elk√∂telezetts√©g f√°zisai',
                    description: 'V√°s√°rl√≥i √∫t meg√©rt√©se',
                    type: 'VIDEO' as const,
                    order: 2,
                    duration: 120,
                    videoUrl: 'https://player.mux.com/VsfzsYtdqZmvtvZgkW00NHZh7dIEEK02KlRpChf6eHyS4?metadata-video-title=Vev%C5%91i+elk%C3%B6telez%C5%91d%C3%A9s+f%C3%A1zisai&video-title=Vev%C5%91i+elk%C3%B6telez%C5%91d%C3%A9s+f%C3%A1zisai',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-4-4',
                    moduleId: 'module-4',
                    courseId: id,
                    title: 'Mire f√≥kusz√°lj, hogy mindenki meg√©rtsen, √©s v√°s√°roljanak t≈ëled? Meghat√°rozzuk az MI seg√≠ts√©g√©vel 2 perc alatt',
                    description: '√úzenet f√≥kusz√°l√°s AI-val',
                    type: 'VIDEO' as const,
                    order: 3,
                    duration: 120,
                    videoUrl: 'https://player.mux.com/OZzSCxaqpHJ59ZhhBfCSu02kDoFwvZJ3ayDWne4FjlDE?metadata-video-title=Mire+f%C3%B3kusz%C3%A1lj%2C+hogy+mindenki+meg%C3%A9rtsen%2C+%C3%A9s+v%C3%A1s%C3%A1roljanak+t%C5%91led%3F+Meghat%C3%A1rozzuk+az+MI+seg%C3%ADts%C3%A9g%C3%A9vel+2+perc+alatt+&video-title=Mire+f%C3%B3kusz%C3%A1lj%2C+hogy+mindenki+meg%C3%A9rtsen%2C+%C3%A9s+v%C3%A1s%C3%A1roljanak+t%C5%91led%3F+Meghat%C3%A1rozzuk+az+MI+seg%C3%ADts%C3%A9g%C3%A9vel+2+perc+alatt+',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-4-5',
                    moduleId: 'module-4',
                    courseId: id,
                    title: 'Egyedi √©rt√©k √©s √©rzelmi aj√°nlat kialak√≠t√°sa mesters√©ges intelligencia sablonb√≥l',
                    description: '√ârt√©kaj√°nlat k√©sz√≠t√©s',
                    type: 'VIDEO' as const,
                    order: 4,
                    duration: 300,
                    videoUrl: 'https://player.mux.com/8ysyo01m602YIhDH201dU8201I00TixT5l3derL3IBO1kv6I?metadata-video-title=Egyedi+%C3%A9rt%C3%A9k+%C3%A9s+%C3%A9rzelmi+aj%C3%A1nlat+kialak%C3%ADt%C3%A1sa+mesters%C3%A9ges+intelligencia+sablonb%C3%B3l&video-title=Egyedi+%C3%A9rt%C3%A9k+%C3%A9s+%C3%A9rzelmi+aj%C3%A1nlat+kialak%C3%ADt%C3%A1sa+mesters%C3%A9ges+intelligencia+sablonb%C3%B3l',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  }
                ]
              },
              {
                id: 'module-5',
                courseId: id,
                title: 'Hogyan sp√≥rolj √≥r√°kat az MI-val ‚Äì √©s √©rj be els≈ëk√©nt a piacra',
                description: 'Gyakorlati AI eszk√∂z√∂k √©s gener√°torok haszn√°lata.',
                order: 4,
                totalLessons: 7,
                totalDuration: 1140,
                status: 'PUBLISHED' as const,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                lessons: [
                  {
                    id: 'lesson-5-1',
                    moduleId: 'module-5',
                    courseId: id,
                    title: 'Szem√©lyre szabott k√∂z√∂ss√©gi m√©dia poszt k√©sz√≠t√©se 3 perc alatt',
                    description: 'Social media automatiz√°ci√≥',
                    type: 'VIDEO' as const,
                    order: 0,
                    duration: 180,
                    videoUrl: 'https://player.mux.com/sRIiDANomGGc01tVBzz5WaaOGL5MkBaupZuQ01T4AoiEM?metadata-video-title=Szem%C3%A9lyre+szabott+k%C3%B6z%C3%B6ss%C3%A9gi+m%C3%A9dia+poszt+k%C3%A9sz%C3%ADt%C3%A9se+3+perc+alatt+&video-title=Szem%C3%A9lyre+szabott+k%C3%B6z%C3%B6ss%C3%A9gi+m%C3%A9dia+poszt+k%C3%A9sz%C3%ADt%C3%A9se+3+perc+alatt+',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-5-2',
                    moduleId: 'module-5',
                    courseId: id,
                    title: 'A piac nem v√°r - √≠gy haszn√°ld az AI-t E-mail marketingre, hogy te legy√©l a gy≈ëztes',
                    description: 'Email marketing AI technik√°k',
                    type: 'VIDEO' as const,
                    order: 1,
                    duration: 300,
                    videoUrl: 'https://player.mux.com/h95zvWKWKweg51qHUu7gSegED900LToW2In9wDjiW4GQ?metadata-video-title=A+piac+nem+v%C3%A1r+-+%C3%ADgy+haszn%C3%A1ld+az+AI-t+E-mail+marketingre%2C+hogy+te+legy%C3%A9l+a+gy%C5%91ztes&video-title=A+piac+nem+v%C3%A1r+-+%C3%ADgy+haszn%C3%A1ld+az+AI-t+E-mail+marketingre%2C+hogy+te+legy%C3%A9l+a+gy%C5%91ztes',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-5-3',
                    moduleId: 'module-5',
                    courseId: id,
                    title: 'Szem√©lyre szabott Facebook hirdet√©s 2 perc alatt',
                    description: 'Facebook Ads optimaliz√°ci√≥',
                    type: 'VIDEO' as const,
                    order: 2,
                    duration: 120,
                    videoUrl: 'https://player.mux.com/RvjZzGc8Y2dsaOx57RlTHF1Y7OoWY02vbNVT1OvtXwzo?metadata-video-title=Szem%C3%A9lyre+szabott+Facebook+hirdet%C3%A9s+2+perc+alatt&video-title=Szem%C3%A9lyre+szabott+Facebook+hirdet%C3%A9s+2+perc+alatt',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-5-4',
                    moduleId: 'module-5',
                    courseId: id,
                    title: 'Bulletpoint gener√°tor - bulletpointok k√©sz√≠t√©se term√©koldalra, landol√≥ oldalra, √©rt√©kes√≠t√©si oldalra 3 percben',
                    description: 'Bulletpoint automatiz√°ci√≥',
                    type: 'VIDEO' as const,
                    order: 3,
                    duration: 180,
                    videoUrl: 'https://player.mux.com/BfpIGZ8xZ1RcrqKD01Qzk2TmSB729QB00QORhrq4HT8Qw?metadata-video-title=Bulletpoint+gener%C3%A1tor+-+bulletpointok+k%C3%A9sz%C3%ADt%C3%A9se+term%C3%A9koldalra%2C+landol%C3%B3+oldalra%2C+%C3%A9rt%C3%A9kes%C3%ADt%C3%A9si+oldalra+3+percben&video-title=Bulletpoint+gener%C3%A1tor+-+bulletpointok+k%C3%A9sz%C3%ADt%C3%A9se+term%C3%A9koldalra%2C+landol%C3%B3+oldalra%2C+%C3%A9rt%C3%A9kes%C3%ADt%C3%A9si+oldalra+3+percben',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-5-5',
                    moduleId: 'module-5',
                    courseId: id,
                    title: 'Blogposzt gener√°tor - blog posztok, amivel a Google-ben az els≈ë oldalra ker√ºlhetsz',
                    description: 'SEO blog content gener√°l√°s',
                    type: 'VIDEO' as const,
                    order: 4,
                    duration: 180,
                    videoUrl: 'https://player.mux.com/OBtxOrngXliDZRbg00vemAUlrWGOXgayLirZHyYLqIKA?metadata-video-title=Blogposzt+gener%C3%A1tor+-+blog+posztok%2C+amivel+a+Google-ben+az+els%C5%91+oldalra+ker%C3%BClhetsz&video-title=Blogposzt+gener%C3%A1tor+-+blog+posztok%2C+amivel+a+Google-ben+az+els%C5%91+oldalra+ker%C3%BClhetsz',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-5-6',
                    moduleId: 'module-5',
                    courseId: id,
                    title: 'Hogyan tedd emberiv√© a sz√∂veged, hogy ne ker√ºlj√∂n a h√≠rlevel spam-be',
                    description: 'Humaniz√°lt tartalom k√©sz√≠t√©se',
                    type: 'VIDEO' as const,
                    order: 5,
                    duration: 60,
                    videoUrl: 'https://player.mux.com/zenvxOXRH8D31379FAyPYU3P1nnZnBjqdK22TsdywlQ?metadata-video-title=Hogyan+tedd+emberiv%C3%A9+a+sz%C3%B6veged%2C+hogy+ne+ker%C3%BClj%C3%B6n+a+h%C3%ADrleveled+spam-be&video-title=Hogyan+tedd+emberiv%C3%A9+a+sz%C3%B6veged%2C+hogy+ne+ker%C3%BClj%C3%B6n+a+h%C3%ADrleveled+spam-be',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  },
                  {
                    id: 'lesson-5-7',
                    moduleId: 'module-5',
                    courseId: id,
                    title: 'Befejez√©s, k√∂sz√∂net!',
                    description: 'Kurzus lez√°r√°sa',
                    type: 'VIDEO' as const,
                    order: 6,
                    duration: 60,
                    videoUrl: 'https://player.mux.com/01qex0100vtX01evBwtGH8TRl182v02ifI9vmLBg2SAiRD1s?metadata-video-title=Befejez%C3%A9s%2C+k%C3%B6sz%C3%B6net%21&video-title=Befejez%C3%A9s%2C+k%C3%B6sz%C3%B6net%21',
                    status: 'PUBLISHED' as const,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                  }
                ]
              }
            ],
            averageRating: 4.9,
            reviewCount: 89,
            enrollmentCount: 312,
            thumbnailUrl: '/Cover_Olvass_a_vev≈ëid_gondolataiban-min.png',
            previewVideoUrl: 'https://player.mux.com/tTZjKcQAhn0233X1jBoj4UARa2nEKnEDRarPGZNUJ2Gg',
            reviews: [],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            certificateEnabled: true,
            language: 'hu',
            difficulty: 'INTERMEDIATE' as const,
            publishDate: new Date().toISOString(),
            isPlus: true,
            status: 'PUBLISHED' as const,
            price: 9990,
            currency: 'HUF',
            isFree: false,
            stripePriceId: 'price_1S0MvyHhqyKpFIBMQdiSPodM',
            objectives: [
              'Buyer persona kidolgoz√°sa 10 perc alatt MI seg√≠ts√©g√©vel',
              'Versenyt√°rs anal√≠zis automatiz√°l√°sa AI eszk√∂z√∂kkel', 
              'Pszichol√≥giai triggerek alkalmaz√°sa a copywritingban',
              'Email marketing automatiz√°ci√≥ k√©sz√≠t√©se',
              'Facebook Ads copy gener√°tor haszn√°lata',
              'Social media tartalom tervez√©s AI-val'
            ],
            prerequisites: [
              'Alapvet≈ë sz√°m√≠t√≥g√©pes ismeretek',
              'Magyar nyelv magas szint≈± ismerete',
              'Nyitotts√°g az √∫j technol√≥gi√°k ir√°nt',
              'V√°llalkoz√≥i vagy marketinges h√°tt√©r el≈ëny'
            ]
          } as unknown as Course);
        }
        
        throw error;
      }
    },
    enabled: !!id,
    staleTime: 5 * 60 * 1000, // Cache for 5 minutes
    retry: 2,
  });
};

export const useUpdateLessonProgress = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({
      courseId,
      lessonId,
      progress,
    }: {
      courseId: string;
      lessonId: string;
      progress: number;
    }) => {
      const response = await fetch(`${FUNCTIONS_BASE_URL}/lessons/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ courseId, lessonId, progress }),
      });
      if (!response.ok) throw new Error('Failed to mark lesson as complete');
      const data = await response.json();
      return data;
    },
    onSuccess: (_, { courseId }) => {
      // Invalidate and refetch course data
      queryClient.invalidateQueries({ queryKey: ['course', courseId] });
    },
  });
};

export const useEnrollInCourse = () => {
  const queryClient = useQueryClient();
  const { user } = useAuth();

  return useMutation({
    mutationFn: async (courseId: string) => {
      // Check authentication
      if (!user) {
        throw new Error('Bejelentkez√©s sz√ºks√©ges a kurzusra val√≥ feliratkoz√°shoz');
      }
      
      // Get auth token
      const token = await auth.currentUser?.getIdToken();
      
      const response = await fetch(`${FUNCTIONS_BASE_URL}/enrollments`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ courseId }),
      });
      const data = await response.json();
      
      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Beiratkoz√°s sikertelen');
      }
      
      return data;
    },
    onSuccess: (_, courseId) => {
      // Invalidate relevant queries
      queryClient.invalidateQueries({ queryKey: ['courses'] });
      queryClient.invalidateQueries({ queryKey: ['course', courseId] });
      queryClient.invalidateQueries({ queryKey: ['enrollments'] });
    },
  });
};