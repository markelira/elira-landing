const admin = require('firebase-admin');

// Initialize Firebase Admin for emulator
process.env.FIREBASE_AUTH_EMULATOR_HOST = '127.0.0.1:9099';
process.env.FIRESTORE_EMULATOR_HOST = '127.0.0.1:8080';

if (!admin.apps.length) {
  admin.initializeApp({
    projectId: 'elira-landing-ce927'
  });
}

const db = admin.firestore();

async function seedFullEmulator() {
  try {
    console.log('üå± Seeding full emulator environment...\n');

    // ============================================================================
    // 1. CREATE COURSE
    // ============================================================================
    console.log('üìö Creating course...');
    const courseId = 'ai-copywriting-course';
    const courseData = {
      title: 'AI Copywriting Kurzus - Teljes Program',
      slug: 'ai-copywriting-course',
      description: `Ez a gyakorlatorient√°lt kurzus mindent megtan√≠t, amit tudnod kell a modern AI-alap√∫ copywritingr√≥l.

      A kurzus sor√°n megismered a ChatGPT √©s m√°s AI eszk√∂z√∂k hat√©kony haszn√°lat√°t, megtanulod a prompt engineering alapjait √©s halad√≥ technik√°it, valamint val√≥s projekteken kereszt√ºl gyakorolhatod a konverzi√≥t n√∂vel≈ë sz√∂vegek √≠r√°s√°t.

      A kurzus v√©g√©re k√©pes leszel √∂n√°ll√≥an, professzion√°lis szinten haszn√°lni az AI eszk√∂z√∂ket copywriting feladatokhoz, legyen sz√≥ landing page-ekr≈ël, email kamp√°nyokr√≥l, vagy social media tartalmakr√≥l.`,
      shortDescription: 'Tanulj meg hat√©kony sz√∂vegeket √≠rni AI eszk√∂z√∂kkel √©s ChatGPT-vel.',
      status: 'PUBLISHED',
      visibility: 'PUBLIC',

      instructorId: 'instructor-1',
      instructorName: 'Kov√°cs Andr√°s',
      instructorEmail: 'andras@elira.hu',
      instructorBio: 'Digital marketing szak√©rt≈ë 10+ √©v tapasztalattal',

      categoryId: 'marketing',
      categoryName: 'Digital Marketing',
      language: 'hu',
      difficulty: 'INTERMEDIATE',

      thumbnailUrl: '/images/course-ai-copywriting.jpg',

      price: 29900,
      currency: 'HUF',
      isFree: false,

      objectives: [
        'AI eszk√∂z√∂k hat√©kony haszn√°lata copywritinghoz',
        'ChatGPT prompt engineering technik√°k elsaj√°t√≠t√°sa',
        'Konverzi√≥t n√∂vel≈ë sz√∂vegt√≠pusok megismer√©se',
        'Landing page √©s email sz√∂vegek √≠r√°sa',
        'A/B tesztel√©s √©s optimaliz√°l√°s AI seg√≠ts√©g√©vel'
      ],

      certificateEnabled: true,
      enrollmentCount: 234,
      completionCount: 156,
      averageRating: 4.8,
      totalReviews: 89,

      totalDuration: 3600,
      totalLessons: 12,
      totalModules: 3,

      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
      publishedAt: admin.firestore.FieldValue.serverTimestamp()
    };

    await db.collection('courses').doc(courseId).set(courseData);
    console.log('‚úÖ Course created: ai-copywriting-course\n');

    // ============================================================================
    // 2. CREATE MODULES
    // ============================================================================
    console.log('üì¶ Creating modules...');
    const moduleIds = [];
    const modules = [
      { title: 'AI Copywriting Alapok', description: 'A ChatGPT √©s AI eszk√∂z√∂k alapjai', duration: 1200 },
      { title: 'Halad√≥ Prompt Engineering', description: 'Halad√≥ technik√°k prompt √≠r√°shoz', duration: 1200 },
      { title: 'Gyakorlati Projektek', description: 'Val√≥s projektek AI-val', duration: 1200 }
    ];

    for (let i = 0; i < modules.length; i++) {
      const module = modules[i];
      const moduleRef = db.collection('modules').doc();
      const moduleId = moduleRef.id;
      moduleIds.push(moduleId);

      await moduleRef.set({
        courseId,
        title: module.title,
        description: module.description,
        duration: module.duration,
        order: i,
        moduleNumber: i + 1,
        isPublished: true,
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
        updatedAt: admin.firestore.FieldValue.serverTimestamp()
      });
      console.log(`‚úÖ Module created: ${module.title}`);
    }
    console.log('');

    // ============================================================================
    // 3. CREATE LESSONS
    // ============================================================================
    console.log('üìù Creating lessons...');
    const lessonsData = [
      // Module 1 lessons
      [
        { title: 'ChatGPT bevezet√©s', duration: 600, type: 'VIDEO' },
        { title: 'AI alapok copywritinghoz', duration: 600, type: 'VIDEO' },
        { title: 'Els≈ë prompt √≠r√°sa', duration: 600, type: 'TEXT' },
        { title: 'Gyakorl√°s', duration: 600, type: 'ASSIGNMENT' }
      ],
      // Module 2 lessons
      [
        { title: 'Prompt strukt√∫r√°k', duration: 600, type: 'VIDEO' },
        { title: 'Context ablak haszn√°lata', duration: 600, type: 'VIDEO' },
        { title: 'Halad√≥ prompt mint√°k', duration: 600, type: 'TEXT' }
      ],
      // Module 3 lessons
      [
        { title: 'Landing page projekt', duration: 600, type: 'VIDEO' },
        { title: 'Email kamp√°ny tervez√©se', duration: 600, type: 'VIDEO' },
        { title: 'Social media tartalmak', duration: 600, type: 'VIDEO' },
        { title: 'Z√°r√≥ projekt √©s √©rt√©kel√©s', duration: 600, type: 'ASSIGNMENT' }
      ]
    ];

    for (let i = 0; i < moduleIds.length; i++) {
      const moduleId = moduleIds[i];
      const lessons = lessonsData[i];

      for (let j = 0; j < lessons.length; j++) {
        const lesson = lessons[j];
        await db.collection('lessons').add({
          moduleId,
          courseId,
          title: lesson.title,
          type: lesson.type,
          duration: lesson.duration,
          order: j,
          lessonNumber: j + 1,
          description: `${lesson.title} - r√©szletes le√≠r√°s`,
          isFreePreview: j === 0,
          isPublished: true,
          createdAt: admin.firestore.FieldValue.serverTimestamp(),
          updatedAt: admin.firestore.FieldValue.serverTimestamp()
        });
      }
      console.log(`‚úÖ Lessons created for module ${i + 1}`);
    }
    console.log('');

    // ============================================================================
    // 4. CREATE USER & ENROLLMENT
    // ============================================================================
    console.log('üë§ Creating test user...');

    // Create auth user
    let userRecord;
    try {
      userRecord = await admin.auth().createUser({
        email: 'mark@elira.hu',
        password: 'password123',
        displayName: 'Mark Elira',
        emailVerified: true,
      });
      console.log('‚úÖ Auth user created');
    } catch (error) {
      if (error.code === 'auth/email-already-exists') {
        // User already exists, get it
        userRecord = await admin.auth().getUserByEmail('mark@elira.hu');
        console.log('‚úÖ Auth user already exists');
      } else {
        throw error;
      }
    }

    // Create Firestore user
    await db.collection('users').doc(userRecord.uid).set({
      uid: userRecord.uid,
      email: 'mark@elira.hu',
      firstName: 'Mark',
      lastName: 'Elira',
      role: 'user',
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    }, { merge: true });
    console.log('‚úÖ Firestore user created');

    // Create enrollment
    const enrollmentRef = db.collection('enrollments').doc();
    await enrollmentRef.set({
      userId: userRecord.uid,
      courseId: courseId,
      enrolledAt: admin.firestore.FieldValue.serverTimestamp(),
      status: 'active',
      progress: 0,
      completedLessons: [],
      lastAccessedAt: admin.firestore.FieldValue.serverTimestamp(),
    });
    console.log('‚úÖ Enrollment created\n');

    // ============================================================================
    // DONE
    // ============================================================================
    console.log('üéâ Full emulator seed complete!\n');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üìß Login Email:    mark@elira.hu');
    console.log('üîë Password:       password123');
    console.log('üîó Course URL:     http://localhost:3000/courses/ai-copywriting-course/learn');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

  } catch (error) {
    console.error('‚ùå Error seeding emulator:', error);
  } finally {
    process.exit(0);
  }
}

seedFullEmulator();
