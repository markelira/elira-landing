const admin = require('firebase-admin');

// Initialize Firebase Admin with service account
const serviceAccount = require('../elira-landing-ce927-firebase-adminsdk-fbsvc-9e1935180c.json');

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    projectId: 'elira-landing-ce927'
  });
}

const db = admin.firestore();

async function updateCoursePrice() {
  try {
    console.log('üîÑ Connecting to Firestore...');
    
    const courseRef = db.collection('courses').doc('ai-copywriting-course');
    const doc = await courseRef.get();
    
    if (doc.exists) {
      const courseData = doc.data();
      console.log('üìã Current course data:');
      console.log('  - Title:', courseData.title);
      console.log('  - Current stripePriceId:', courseData.stripePriceId);
      console.log('  - Price:', courseData.price, courseData.currency);
      
      console.log('\nüîÑ Updating to new price ID: price_1SAbPbHhqyKpFIBMcfdPF1Lh');
      
      await courseRef.update({
        stripePriceId: 'price_1SAbPbHhqyKpFIBMcfdPF1Lh',
        updatedAt: admin.firestore.FieldValue.serverTimestamp()
      });
      
      // Verify the update
      const updatedDoc = await courseRef.get();
      const updatedData = updatedDoc.data();
      
      console.log('\n‚úÖ Course stripePriceId updated successfully!');
      console.log('  - New stripePriceId:', updatedData.stripePriceId);
      console.log('  - Updated at:', new Date().toISOString());
    } else {
      console.log('‚ùå Course not found: ai-copywriting-course');
      console.log('Creating course with new price ID...');
      
      // Create the course if it doesn't exist
      await courseRef.set({
        title: 'AI-alap√∫ piac-kutat√°sos copywriting',
        description: 'Tanuld meg, hogyan haszn√°ld az AI eszk√∂z√∂ket hat√©kony sz√∂vegek √≠r√°s√°hoz.',
        instructorName: 'Eszterh√°zy M√°rk',
        instructorTitle: 'Digital Marketing Szak√©rt≈ë',
        instructorBio: '10+ √©v tapasztalat a digit√°lis marketingben √©s AI copywritingban',
        category: 'Digital Marketing',
        difficulty: 'BEGINNER',
        language: 'hu',
        price: 49990,
        currency: 'HUF',
        thumbnailUrl: '/Cover_Olvass_a_vev≈ëid_gondolataiban-min.png',
        totalDuration: 3360,
        totalLessons: 17,
        status: 'PUBLISHED',
        isFree: false,
        stripePriceId: 'price_1SAbPbHhqyKpFIBMcfdPF1Lh',
        stripeProductId: 'prod_SwFQ50r0KCrxss',
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
        updatedAt: admin.firestore.FieldValue.serverTimestamp(),
        publishedAt: admin.firestore.FieldValue.serverTimestamp()
      });
      
      console.log('‚úÖ Course created with new price ID');
    }
  } catch (error) {
    console.error('‚ùå Error:', error.message);
    console.error('Stack:', error.stack);
  } finally {
    // Terminate the app to exit the script
    await admin.app().delete();
    process.exit(0);
  }
}

// Run the update
updateCoursePrice();