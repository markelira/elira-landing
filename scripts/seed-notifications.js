/**
 * Script to seed notification data into Firestore
 *
 * Usage: node scripts/seed-notifications.js <userId>
 *
 * This creates sample notifications for testing the notification system
 */

const admin = require('firebase-admin');
const path = require('path');

// Initialize Firebase Admin
const serviceAccountPath = path.resolve(__dirname, '../elira-landing-ce927-firebase-adminsdk-fbsvc-9e1935180c.json');

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccountPath),
  });
}

const db = admin.firestore();

// Get userId from command line args
const userId = process.argv[2];

if (!userId) {
  console.error('‚ùå Error: Please provide a userId as an argument');
  console.log('Usage: node scripts/seed-notifications.js <userId>');
  process.exit(1);
}

async function seedNotifications() {
  console.log(`üå± Creating notifications for user: ${userId}`);

  const now = admin.firestore.Timestamp.now();
  const yesterday = admin.firestore.Timestamp.fromDate(
    new Date(Date.now() - 24 * 60 * 60 * 1000)
  );
  const twoDaysAgo = admin.firestore.Timestamp.fromDate(
    new Date(Date.now() - 2 * 24 * 60 * 60 * 1000)
  );

  // Sample notifications of different types
  const notifications = [
    {
      userId,
      type: 'consultation_reminder',
      title: 'El≈ëtt√ºnk √°ll a konzult√°ci√≥',
      message: 'A Marketing Seb√©szet konzult√°ci√≥d holnap 10:00-kor kezd≈ëdik. K√©sz√ºlj fel a megbesz√©lt t√©m√°kra!',
      priority: 'high',
      read: false,
      actionUrl: '/dashboard',
      actionText: 'R√©szletek megtekint√©se',
      metadata: {
        consultationId: 'sample-consultation-1',
      },
      createdAt: now,
    },
    {
      userId,
      type: 'new_module',
      title: '√öj modul el√©rhet≈ë',
      message: 'A Marketing Seb√©szet program k√∂vetkez≈ë modulja m√°r el√©rhet≈ë sz√°modra: "Buyer Persona Kutat√°s"',
      priority: 'medium',
      read: false,
      actionUrl: '/courses/ai-copywriting-course/learn',
      actionText: 'Modul megnyit√°sa',
      metadata: {
        courseId: 'ai-copywriting-course',
        moduleId: 'module-2',
      },
      createdAt: yesterday,
    },
    {
      userId,
      type: 'achievement',
      title: 'Teljes√≠tm√©ny feloldva!',
      message: 'Gratul√°lunk! El√©rted a "7 napos sztr√≠k" teljes√≠tm√©nyt.',
      priority: 'medium',
      read: false,
      actionUrl: '/dashboard',
      actionText: 'Teljes√≠tm√©nyek megtekint√©se',
      metadata: {
        achievementId: 'week-streak',
        tier: 'bronze',
      },
      createdAt: twoDaysAgo,
    },
    {
      userId,
      type: 'instructor_message',
      title: '√úzenet Zolit√≥l',
      message: 'Nagyszer≈± munk√°t v√©gezt√©l az els≈ë h√©ten! Folytat√°sk√©nt √©rdemes elolvasni a k√∂vetkez≈ë h√©ten...',
      priority: 'medium',
      read: true,
      readAt: yesterday,
      actionUrl: '/dashboard',
      actionText: '√úzenet elolvas√°sa',
      metadata: {
        instructorId: 'instructor-zoli',
      },
      createdAt: twoDaysAgo,
    },
    {
      userId,
      type: 'system',
      title: 'Rendszer friss√≠t√©s',
      message: 'Az Elira platformon √∫j funkci√≥k √©rhet≈ëk el: heti √∂sszefoglal√≥k √©s teljes√≠tm√©nyrendszer.',
      priority: 'low',
      read: true,
      readAt: twoDaysAgo,
      metadata: {},
      createdAt: admin.firestore.Timestamp.fromDate(
        new Date(Date.now() - 3 * 24 * 60 * 60 * 1000)
      ),
    },
  ];

  try {
    // Create notifications in subcollection
    const batch = db.batch();

    for (const notification of notifications) {
      const notificationRef = db
        .collection('notifications')
        .doc(userId)
        .collection('items')
        .doc();

      batch.set(notificationRef, {
        ...notification,
        notificationId: notificationRef.id,
      });
    }

    await batch.commit();

    console.log('‚úÖ Successfully created notifications:');
    console.log(`   - ${notifications.length} notifications seeded`);
    console.log(`   - ${notifications.filter(n => !n.read).length} unread`);
    console.log(`   - ${notifications.filter(n => n.read).length} read`);
    console.log('');
    console.log('üìã Notification types:');
    notifications.forEach((n, i) => {
      console.log(`   ${i + 1}. [${n.type}] ${n.title} ${n.read ? '(read)' : '(unread)'}`);
    });
    console.log('');
    console.log('üîî Visit http://localhost:3001/dashboard to see notifications');

  } catch (error) {
    console.error('‚ùå Error seeding notifications:', error);
    throw error;
  }
}

// Run the seed function
seedNotifications()
  .then(() => {
    console.log('‚úÖ Notification seeding complete!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('‚ùå Seeding failed:', error);
    process.exit(1);
  });
