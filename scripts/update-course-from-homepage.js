const admin = require('firebase-admin');

// Initialize Firebase Admin for emulator
process.env.FIREBASE_AUTH_EMULATOR_HOST = '127.0.0.1:9099';
process.env.FIRESTORE_EMULATOR_HOST = '127.0.0.1:8080';

if (!admin.apps.length) {
  admin.initializeApp({
    projectId: 'elira-landing-ce927'
  });
}

const db = admin.firestore();

async function updateCourseFromHomepage() {
  try {
    console.log('üîÑ Updating ai-copywriting-course with homepage data...');
    
    const courseId = 'ai-copywriting-course';
    
    // Complete course data extracted from homepage components
    const courseData = {
      // Basic info
      title: 'Olvass a vev≈ëid gondolataiban',
      slug: 'ai-copywriting-course',
      description: 'AI-alap√∫ copywriting √©s marketingkutat√°s kurzus. K√©pzeld el, hogy percek alatt k√©sz√≠tesz buyer person√°t, pontosan felt√©rk√©pezed a piacodat, √©s az MI-vel olyan sz√∂vegeket √≠rsz, amelyek nem csak a figyelmet ragadj√°k meg, hanem profitot is termelnek.',
      shortDescription: 'Tanulj meg hat√©kony sz√∂vegeket √≠rni AI eszk√∂z√∂kkel √©s ChatGPT-vel.',
      status: 'PUBLISHED',
      visibility: 'PUBLIC',
      
      // Instructor - from ZoliIntroduction component
      instructorId: 'zoltan-somosi',
      instructorName: 'Somosi Zolt√°n',
      instructorEmail: 'zoltan@elira.hu',
      instructorBio: 'E-mail √©s trigger marketing specialista a Heureka Groupn√°l, √©s doktorandusz a Miskolci Egyetemen, ahol a mesters√©ges intelligencia √©s az online marketing hat√©konys√°ga a kutat√°si ter√ºletem.',
      instructorPhotoUrl: '/IMG_5730.JPG',
      instructorTitle: 'Marketing Specialista & Doktorandusz',
      instructorInstitution: 'Miskolci Egyetem & Heureka Group',
      instructorLinkedIn: 'https://linkedin.com/in/zolt√°n-somosi-299605226',
      
      // Category
      categoryId: 'ai-marketing',
      categoryName: 'AI Marketing',
      language: 'hu',
      difficulty: 'INTERMEDIATE',
      
      // Media
      thumbnailUrl: '/Cover_Olvass_a_vev≈ëid_gondolataiban-min.png',
      previewVideoUrl: 'https://player.mux.com/tTZjKcQAhn0233X1jBoj4UARa2nEKnEDRarPGZNUJ2Gg',
      
      // Pricing - from PricingSection and Stripe configuration
      price: 9990,
      currency: 'HUF',
      isFree: false,
      stripePriceId: 'price_1S0MvyHhqyKpFIBMQdiSPodM',
      stripeProductId: 'prod_SwFQ50r0KCrxss',
      
      // Learning objectives - from CourseDetailsSection highlights
      objectives: [
        'Buyer persona kidolgoz√°sa 10 perc alatt MI seg√≠ts√©g√©vel',
        'Versenyt√°rs anal√≠zis automatiz√°l√°sa AI eszk√∂z√∂kkel',
        'Pszichol√≥giai triggerek alkalmaz√°sa a copywritingban',
        'Email marketing automatiz√°ci√≥ k√©sz√≠t√©se',
        'Facebook Ads copy gener√°tor haszn√°lata',
        'Social media tartalom tervez√©s AI-val'
      ],
      
      prerequisites: [
        'Alapvet≈ë sz√°m√≠t√≥g√©pes ismeretek',
        'Magyar nyelv magas szint≈± ismerete', 
        'Nyitotts√°g az √∫j technol√≥gi√°k ir√°nt',
        'V√°llalkoz√≥i vagy marketinges h√°tt√©r el≈ëny'
      ],
      
      targetAudience: [
        'V√°llalkoz√≥k, akik megunta, hogy minden fill√©rt √ºgyn√∂ks√©gekre k√∂lt',
        'Marketingesek, akiket a f≈ën√∂k folyamatosan szor√≠t jobb sz√°mok√©rt',
        'Akik tiszt√°ban vannak vele, hogy lemaradnak az AI forradalomr√≥l'
      ],
      
      // Course features - from homepage components
      features: [
        'Buyer persona k√©sz√≠t√©se 5 perc alatt MI seg√≠ts√©g√©vel',
        'F√°jdalompontok felt√°r√°sa automatiz√°lt m√≥dszerekkel',
        'Profitn√∂vel≈ë sz√∂veg√≠r√°s AI-val',
        'MI-sablonok k√©sz√≠t√©se √©s haszn√°lata',
        'Konkr√©t p√©ld√°k √©s gyakorlatok',
        '7 let√∂lthet≈ë PDF sablon',
        'Azonnali hozz√°f√©r√©s',
        '30 napos p√©nzvisszafizet√©si garancia'
      ],
      
      // Settings
      certificateEnabled: true,
      
      // Stats - from homepage
      enrollmentCount: 312,
      completionCount: 200,
      averageRating: 4.9,
      totalReviews: 89,
      
      // Content stats - from CourseDetailsSection
      totalModules: 5,
      totalLessons: 17,
      totalDuration: 3360, // 56 minutes in seconds
      totalVideos: 17,
      totalPDFs: 7,
      
      // Timestamps
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
      publishedAt: admin.firestore.FieldValue.serverTimestamp(),
      
      // Additional metadata
      isPlus: true,
      isFeatured: true,
      tags: ['AI', 'Copywriting', 'Marketing', 'ChatGPT', 'Email Marketing', 'Facebook Ads'],
      seoKeywords: ['AI copywriting', 'mesters√©ges intelligencia marketing', 'ChatGPT copywriting', 'buyer persona', 'email marketing'],
      
      // Course value proposition
      courseValue: {
        totalComponentValue: 32000, // From PricingSection calculation
        actualPrice: 9990,
        savings: 22010,
        valueComponents: [
          { text: '5 modul, 17 vide√≥ (56 perc)', value: 8000 },
          { text: '7 AI gener√°tor PDF', value: 5000 },
          { text: 'Gyakorlati AI prompt sablonok', value: 3000 },
          { text: 'Doktorandusz oktat√≥ szak√©rtelem', value: 12000 },
          { text: 'Magyar piacra szabott tartalom', value: 4000 }
        ]
      }
    };
    
    // Update the course document
    await db.collection('courses').doc(courseId).set(courseData, { merge: true });
    console.log('‚úÖ Course updated with homepage data:', courseId);
    
    // Create/update modules with detailed content from CourseDetailsSection
    const modules = [
      {
        id: 'module-1',
        courseId,
        title: 'Alkoss hidat k√∂zted, √©s a vev≈ë k√∂z√∂tt - hogyan √©rintsd meg a vev≈ëdet',
        description: 'A kommunik√°ci√≥dban mindig te vagy a f≈ëh≈ës, nem a vev≈ë. Tal√°ld meg a k√∂z√∂s nevez≈ët a vev≈ëddel.',
        order: 0,
        totalLessons: 1,
        totalDuration: 240, // 4 minutes
        status: 'PUBLISHED',
        lessons: [
          {
            id: 'lesson-1-1',
            title: 'Bevezet√©s - Hogyan ford√≠tsd meg a kommunik√°ci√≥t, hogy a vev≈ë azt mondja: ‚ÄûPont ≈ë kell nekem"',
            duration: 240,
            type: 'VIDEO',
            order: 0,
            isFreePreview: true
          }
        ]
      },
      {
        id: 'module-2',
        courseId,
        title: 'Hogyan √°ll√≠tsd be a kommunik√°ci√≥d, hogy csak azok hallj√°k, akik fizetni fognak',
        description: 'Pontos c√©lz√°s √©s c√©lcsoport meghat√°roz√°s AI eszk√∂z√∂kkel.',
        order: 1,
        totalLessons: 3,
        totalDuration: 720, // 12 minutes
        status: 'PUBLISHED',
        lessons: [
          {
            id: 'lesson-2-1',
            title: 'Pontos c√©lz√°s, biztos tal√°lat - tal√°lj c√©lba a c√©lcsoportodn√°l',
            duration: 240,
            type: 'VIDEO',
            order: 0
          },
          {
            id: 'lesson-2-2',
            title: 'V√©lem√©nyek √©s trendek - hogyan der√≠tsd ki mire v√°gynak √©s mit≈ël f√©lnek a potenci√°lis v√°s√°rl√≥id?',
            duration: 240,
            type: 'VIDEO',
            order: 1
          },
          {
            id: 'lesson-2-3',
            title: '√ñsszefoglal√°s - a legfontosabb vev≈ëi insightok',
            duration: 240,
            type: 'VIDEO',
            order: 2
          }
        ]
      },
      {
        id: 'module-3',
        courseId,
        title: 'Ha nem ismered a vev≈ëdet, elvesz√≠ted a piacot t√©rk√©pezd fel azonnal!',
        description: 'Buyer persona k√©sz√≠t√©s √©s piackutat√°s AI eszk√∂z√∂kkel.',
        order: 2,
        totalLessons: 1,
        totalDuration: 540, // 9 minutes
        status: 'PUBLISHED',
        lessons: [
          {
            id: 'lesson-3-1',
            title: 'Buyer persona - komplett vev≈ëi profil meghat√°roz√°sa 10 perc alatt ChatGPT-vel, val√≥s adatokb√≥l',
            duration: 540,
            type: 'VIDEO',
            order: 0
          }
        ]
      },
      {
        id: 'module-4',
        courseId,
        title: 'Hogyan √≠rd √∫gy az √ºzeneted, hogy el≈ësz√∂r √©rezze, azt√°n √©rtse meg ‚Äì √©s v√©g√ºl v√°s√°roljon',
        description: 'Pszichol√≥giai triggerek √©s √©rzelmi copywriting technik√°k.',
        order: 3,
        totalLessons: 5,
        totalDuration: 720, // 12 minutes
        status: 'PUBLISHED',
        lessons: [
          {
            id: 'lesson-4-1',
            title: '√ârintsd meg a sz√≠v√©t, azt√°n a fej√©t - √≠gy nyersz √∂r√∂kre v√°s√°rl√≥t!',
            duration: 120,
            type: 'VIDEO',
            order: 0
          },
          {
            id: 'lesson-4-2',
            title: 'Haszn√°ld a ‚ÄûNa √©s?" technik√°t, hogy eljuss az el≈ëny√∂kh√∂z',
            duration: 60,
            type: 'VIDEO',
            order: 1
          },
          {
            id: 'lesson-4-3',
            title: 'Vev≈ëi elk√∂telezetts√©g f√°zisai',
            duration: 120,
            type: 'VIDEO',
            order: 2
          },
          {
            id: 'lesson-4-4',
            title: 'Mire f√≥kusz√°lj, hogy mindenki meg√©rtsen, √©s v√°s√°roljanak t≈ëled? Meghat√°rozzuk az MI seg√≠ts√©g√©vel 2 perc alatt',
            duration: 120,
            type: 'VIDEO',
            order: 3
          },
          {
            id: 'lesson-4-5',
            title: 'Egyedi √©rt√©k √©s √©rzelmi aj√°nlat kialak√≠t√°sa mesters√©ges intelligencia sablonb√≥l',
            duration: 300,
            type: 'VIDEO',
            order: 4
          }
        ]
      },
      {
        id: 'module-5',
        courseId,
        title: 'Hogyan sp√≥rolj √≥r√°kat az MI-val ‚Äì √©s √©rj be els≈ëk√©nt a piacra',
        description: 'Gyakorlati AI eszk√∂z√∂k √©s gener√°torok haszn√°lata.',
        order: 4,
        totalLessons: 7,
        totalDuration: 1140, // 19 minutes
        status: 'PUBLISHED',
        lessons: [
          {
            id: 'lesson-5-1',
            title: 'Szem√©lyre szabott k√∂z√∂ss√©gi m√©dia poszt k√©sz√≠t√©se 3 perc alatt',
            duration: 180,
            type: 'VIDEO',
            order: 0
          },
          {
            id: 'lesson-5-2',
            title: 'A piac nem v√°r - √≠gy haszn√°ld az AI-t E-mail marketingre, hogy te legy√©l a gy≈ëztes',
            duration: 300,
            type: 'VIDEO',
            order: 1
          },
          {
            id: 'lesson-5-3',
            title: 'Szem√©lyre szabott Facebook hirdet√©s 2 perc alatt',
            duration: 120,
            type: 'VIDEO',
            order: 2
          },
          {
            id: 'lesson-5-4',
            title: 'Bulletpoint gener√°tor - bulletpointok k√©sz√≠t√©se term√©koldalra, landol√≥ oldalra, √©rt√©kes√≠t√©si oldalra 3 percben',
            duration: 180,
            type: 'VIDEO',
            order: 3
          },
          {
            id: 'lesson-5-5',
            title: 'Blogposzt gener√°tor - blog posztok, amivel a Google-ben az els≈ë oldalra ker√ºlhetsz',
            duration: 180,
            type: 'VIDEO',
            order: 4
          },
          {
            id: 'lesson-5-6',
            title: 'Hogyan tedd emberiv√© a sz√∂veged, hogy ne ker√ºlj√∂n a h√≠rlevel spam-be',
            duration: 60,
            type: 'VIDEO',
            order: 5
          },
          {
            id: 'lesson-5-7',
            title: 'Befejez√©s, k√∂sz√∂net!',
            duration: 60,
            type: 'VIDEO',
            order: 6
          }
        ]
      }
    ];

    // PDF resources - from CourseDetailsSection
    const pdfResources = [
      'Blogposzt gener√°tor.pdf',
      'Bulletpoint gener√°tor.pdf', 
      'Buyer persona gener√°tor.pdf',
      'Buyer persona.pdf',
      'email marketing gener√°tor.pdf',
      'Facebook ads copy gener√°tor.pdf',
      'K√∂z√∂ss√©gi m√©dia poszt gener√°tor.pdf'
    ];

    // Add PDF resources to course data
    courseData.pdfResources = pdfResources;
    courseData.totalPDFs = pdfResources.length;

    // Update the main course document
    await db.collection('courses').doc(courseId).set(courseData, { merge: true });
    console.log('‚úÖ Main course document updated');

    // Create/update modules and lessons
    const batch = db.batch();
    
    for (const module of modules) {
      const moduleRef = db.collection('modules').doc(module.id);
      const { lessons, ...moduleData } = module;
      
      batch.set(moduleRef, {
        ...moduleData,
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
        updatedAt: admin.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      // Create lessons for this module
      for (const lesson of lessons) {
        const lessonRef = db.collection('lessons').doc(lesson.id);
        batch.set(lessonRef, {
          ...lesson,
          moduleId: module.id,
          courseId,
          description: `${lesson.title} - r√©szletes magyar√°zat`,
          isPublished: true,
          createdAt: admin.firestore.FieldValue.serverTimestamp(),
          updatedAt: admin.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      }
    }

    // Create PDF resource documents
    for (let i = 0; i < pdfResources.length; i++) {
      const pdfName = pdfResources[i];
      const pdfRef = db.collection('course-resources').doc(`pdf-${i + 1}`);
      batch.set(pdfRef, {
        courseId,
        type: 'PDF',
        title: pdfName,
        filename: pdfName,
        downloadUrl: `/docs/${pdfName}`,
        order: i,
        isPublished: true,
        createdAt: admin.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    // Commit all changes
    await batch.commit();
    console.log('‚úÖ Modules, lessons, and resources created/updated');
    
    console.log('\nüéâ Course integration complete!');
    console.log(`üìç Course ID: ${courseId}`);
    console.log(`üí∞ Price: ${courseData.price} ${courseData.currency}`);
    console.log(`üí≥ Stripe Price ID: ${courseData.stripePriceId}`);
    console.log(`üîó Product ID: ${courseData.stripeProductId}`);
    console.log(`üìö Total Modules: ${modules.length}`);
    console.log(`üìñ Total Lessons: ${modules.reduce((sum, m) => sum + m.lessons.length, 0)}`);
    console.log(`üìÑ Total PDFs: ${pdfResources.length}`);
    console.log(`‚è±Ô∏è Total Duration: ${Math.round(courseData.totalDuration / 60)} minutes`);
    
  } catch (error) {
    console.error('‚ùå Error updating course:', error);
  } finally {
    process.exit(0);
  }
}

updateCourseFromHomepage();