// Get Discord webhook URL from environment variables
const DISCORD_WEBHOOK_URL = process.env.DISCORD_WEBHOOK_URL || '';

// Lead magnet display names in Hungarian
const magnetNames: Record<string, string> = {
  'chatgpt-prompts': 'ü§ñ ChatGPT Prompt Gy≈±jtem√©ny',
  'linkedin-calendar': 'üìà 30 Napos LinkedIn Napt√°r',
  'email-templates': 'üìß Email Marketing Sablonok',
  'tiktok-guide': 'üé¨ TikTok Algoritmus Guide',
  'automation-workflows': '‚ö° Marketing Automatiz√°ci√≥',
  'none': 'üìö √Åltal√°nos tartalom'
};

// Job/Career display names
const jobNames: Record<string, string> = {
  'Marketing': 'üìä Marketing',
  'IT/Fejleszt≈ë': 'üíª IT/Fejleszt≈ë',
  'HR': 'üë• HR',
  'P√©nz√ºgy': 'üí∞ P√©nz√ºgy',
  '√ârt√©kes√≠t√©s': 'üíº √ârt√©kes√≠t√©s',
  'Vezet≈ëi poz√≠ci√≥': 'üëî Vezet≈ëi poz√≠ci√≥',
  'Di√°k': 'üéì Di√°k',
  'Egy√©b': 'üîÑ Egy√©b',
  'Not specified': '‚ùì Nem adta meg'
};

export async function sendDiscordNotification(
  name: string,
  magnetSelected: string,
  job?: string,
  education?: string
): Promise<{ success: boolean; error?: any }> {
  // Check if Discord webhook is configured
  if (!DISCORD_WEBHOOK_URL) {
    console.error('Discord webhook URL not configured');
    return { success: false, error: 'Discord not configured' };
  }

  try {
    // Create a rich embed message
    const message = {
      content: null, // No plain text content, using embed
      embeds: [{
        title: "üéâ √öj Elira Tag Csatlakozott!",
        description: `**${name}** most regisztr√°lt √©s let√∂lt√∂tte az ingyenes anyagokat!`,
        color: 0x0d9488, // Teal color matching the brand
        fields: [
          {
            name: "üë§ N√©v",
            value: name || 'Ismeretlen',
            inline: true
          },
          {
            name: "üìö Let√∂lt√∂tt anyag",
            value: magnetNames[magnetSelected] || magnetSelected || '√Åltal√°nos',
            inline: true
          },
          {
            name: "üíº Szakter√ºlet",
            value: jobNames[job || 'Not specified'] || job || 'Nem adta meg',
            inline: true
          },
          {
            name: "üéì V√©gzetts√©g",
            value: education || 'Nem adta meg',
            inline: true
          },
          {
            name: "‚è∞ Csatlakoz√°s id≈ëpontja",
            value: new Date().toLocaleString('hu-HU', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              timeZone: 'Europe/Budapest'
            }),
            inline: false
          }
        ],
        footer: {
          text: "Elira Landing Page ‚Ä¢ Automatikus √©rtes√≠t√©s",
          icon_url: "https://elira.hu/favicon.ico"
        },
        timestamp: new Date().toISOString(),
        thumbnail: {
          url: "https://cdn.discordapp.com/attachments/YOUR_CHANNEL/celebration.gif" // You can add a celebration GIF here
        }
      }],
      // Optional: Add components (buttons)
      components: [{
        type: 1,
        components: [
          {
            type: 2,
            style: 5, // Link button
            label: "√údv√∂z√∂ld ≈ët a Discord-on",
            url: "https://discord.gg/mcUyZXGERT",
            emoji: {
              name: "üëã"
            }
          }
        ]
      }]
    };

    // Send to Discord
    const response = await fetch(DISCORD_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(message)
    });

    // Discord returns 204 No Content on success
    if (response.ok || response.status === 204) {
      console.log('Discord notification sent successfully for:', name);
      return { success: true };
    } else {
      const errorText = await response.text();
      console.error(`Discord webhook failed: ${response.status} - ${errorText}`);
      return { 
        success: false, 
        error: `Discord webhook failed: ${response.status}`
      };
    }
  } catch (error) {
    console.error('Discord webhook error:', error);
    // Don't throw - this shouldn't break the main flow
    return { success: false, error };
  }
}

// Optional: Send a simple text notification (lighter version)
export async function sendSimpleDiscordNotification(
  message: string
): Promise<{ success: boolean; error?: any }> {
  try {
    const response = await fetch(DISCORD_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        content: message
      })
    });

    if (response.ok || response.status === 204) {
      return { success: true };
    } else {
      return { 
        success: false, 
        error: `Discord webhook failed: ${response.status}`
      };
    }
  } catch (error) {
    console.error('Discord webhook error:', error);
    return { success: false, error };
  }
}

// Send activity notification for other events
export async function sendDiscordActivity(
  type: 'download' | 'join_discord' | 'question',
  userName: string,
  details?: string
): Promise<{ success: boolean; error?: any }> {
  const activityMessages = {
    download: `üì• **${userName}** √©ppen let√∂lt√∂tt egy anyagot`,
    join_discord: `üí¨ **${userName}** bel√©pett a Discord szerver√ºnkre!`,
    question: `‚ùì **${userName}** k√©rd√©st tett fel`
  };

  const colors = {
    download: 0x3b82f6, // Blue
    join_discord: 0x7c3aed, // Purple
    question: 0xf59e0b // Amber
  };

  try {
    const message = {
      embeds: [{
        description: activityMessages[type],
        color: colors[type],
        fields: details ? [{
          name: "R√©szletek",
          value: details,
          inline: false
        }] : [],
        footer: {
          text: `Elira ‚Ä¢ ${new Date().toLocaleTimeString('hu-HU', { timeZone: 'Europe/Budapest' })}`
        }
      }]
    };

    const response = await fetch(DISCORD_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(message)
    });

    return { 
      success: response.ok || response.status === 204 
    };
  } catch (error) {
    console.error('Discord activity notification error:', error);
    return { success: false, error };
  }
}